
### 程序流程图




### 程序架构图



### api接口文档
swagger自动生成

### 程序设计
#### 1. 系统架构
- 后端：nodejs(v20.5.0)+express(4.21.1)+mysql(8.0.37)
- 中间件：cors(用于跨域请求)+json(解析json格式数据)+expressJwt(用于jwt令牌验证)+bcriptjs(用于密码加密与解密)+joi(用于数据验证)+multer(用于文件上传)+使用morgan中间件，将日志信息写入文件

#### 2. 功能模块
- 用户管理：
    - 医生
      - 登陆
      - 修改个人信息（包括修改）
    - 管理员
      - 管理平台的所有数据
- 眼底图库管理：眼底图片的批量上传、编辑、删除等。
- 患者管理：患者信息的增删改查。
- 眼底疾病识别管理：
  - 选择入库的患者，从图库选择该患者的眼底图片识别，返回检测结果。
  - 对识别结果进行确认，录入库中
  - 给出诊断意见，录入库中
  - 预测治疗费用，录入库中
- 大屏展示
  -展示各种眼部疾病的地区分布
  -展示眼部疾病在不同年龄阶段，不同性别的发病情况
  -展示患者的治疗过程
  -展示患者的治疗费用情况

#### 3. 数据库设计
如下：  
用户信息表：  user_info  
>
Name	Code	Data Type	Length	Precision	Primary	Foreign Key	Mandatory  
名字	name	varchar(20)	20		FALSE	FALSE	FALSE  
用户名	username	varchar(32)	32		FALSE	FALSE	FALSE（不能为空）  
密码	password	varchar(32)	32		FALSE	FALSE	FALSE（不能为空）  
用户id	id	varchar(50)	50		TRUE	FALSE	TRUE（不能为空）  
用户类型	type	smallint			FALSE	FALSE	FALSE （不能为空）（0为医生，1为管理）  
电话	phone	char(11)	11		FALSE	FALSE	FALSE  
邮箱	email	varchar(20)	20		FALSE	FALSE	FALSE  
住址	address	varchar(50)	50		FALSE	FALSE	FALSE  
性别	sex	smallint			FALSE	FALSE	FALSE （0为女，1为男）  
> 

患者信息表：  patient_info  
>
Name	Code	Data Type	Length	Precision	Primary	Foreign Key	Mandatory  
患者id	patient_id	varchar(50)	50		TRUE	FALSE	TRUE （不能为空）  
用户id	id	varchar(50)	50		FALSE	TRUE	FALSE （不能为空）  
姓名	patient_name	varchar(20)	20		FALSE	FALSE	FALSE （不能为空）  
电话	patient_phone	char(11)	11		FALSE	FALSE	FALSE  
住址	patient_address	varchar(50)	50		FALSE	FALSE	FALSE （不能为空）  
性别	patient_sex	smallint			FALSE	FALSE	FALSE （不能为空）  
年龄	patient_age	numeric(8,0)	8		FALSE	FALSE	FALSE （不能为空）  
治疗状态	curestate	varchar(25)	25		FALSE	FALSE	FALSE  
诊断结果	result	varchar(25)	25		FALSE	FALSE	FALSE  
治疗建议	cureadvice	varchar(1000)	1,000		FALSE	FALSE	FALSE  
费用	cost	varchar(50)	50		FALSE	FALSE	FALSE （默认为0）  
>

眼底图库表：  chart_gallery
>
Name	Code	Data Type	Length	Precision	Primary	Foreign Key	Mandatory
图片id	img_id	varchar(50)	50		TRUE	FALSE	TRUE  （不能为空）
患者id	patient_id	varchar(50)	50		FALSE	TRUE	FALSE 
用户id	id	varchar(50)	50		FALSE	TRUE	FALSE （不能为空）
图片url	img_url	varchar(500)	500		FALSE	FALSE	FALSE （不能为空）

### 问题记录
1. 未授权问题  
好像是token认证unless函数里面写出不需要token的路由  
2. 用户角色权限认证，自定义中间件，
    注意jwt.vertify可以验证token，进行解析，注意此时token不需要包含bearer，所以需要去掉
3. multer中间件，上传文件，需要指定文件类型，否则会报错.
4. 存储引擎为本地磁盘，当前端要数据的时候，查询到所有信息之后，把图片的url存储到数据库中，然后前端通过url来获取图片，但是url是相对路径，所以需要把url拼接上服务器地址，这样前端才能获取到图片。或者使用base64的格式直接返回给前端，这样更加方便。
